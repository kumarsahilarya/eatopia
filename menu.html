<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Menu Manager</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-black text-white min-h-screen p-6 font-sans">

  <!-- Header -->
  <div class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4">
    <h1 class="text-3xl font-bold text-yellow-400">üçΩÔ∏è Kitchen Menu</h1>
    <div class="flex gap-4">
      <input type="text" id="searchInput" placeholder="Search..." class="px-3 py-2 rounded bg-gray-800 text-white border border-yellow-300" />
      <button onclick="openModal()" class="bg-yellow-400 hover:bg-yellow-300 text-black px-4 py-2 rounded-lg font-semibold shadow-lg">
        + Add Item
      </button>
    </div>
  </div>

  <!-- Menu Grid -->
  <div id="menuList" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6"></div>

  <!-- Loading Spinner -->
  <div id="loading" class="text-center mt-10 hidden">
    <div class="animate-spin rounded-full h-12 w-12 border-t-4 border-yellow-400 mx-auto"></div>
    <p class="mt-2 text-gray-400">Loading menu...</p>
  </div>

  <!-- Add/Edit Modal -->
  <div id="modal" class="fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center hidden z-50">
    <div class="bg-gray-900 rounded-xl w-full max-w-md p-6 shadow-2xl border border-yellow-400 relative">
      <h2 id="modalTitle" class="text-xl font-bold mb-4 text-yellow-400">Add New Menu Item</h2>
      <form id="menuForm">
        <input type="hidden" id="kitchenId" value="YOUR_KITCHEN_ID" />
        <input type="hidden" id="editingItemId" />

        <label class="block mb-1">Name</label>
        <input type="text" id="itemName" required class="w-full bg-black border border-gray-600 px-3 py-2 mb-4 rounded text-white"/>

        <label class="block mb-1">Price</label>
        <input type="number" id="itemPrice" required class="w-full bg-black border border-gray-600 px-3 py-2 mb-4 rounded text-white"/>

        <label class="block mb-1">Description</label>
        <textarea id="itemDescription" rows="3" class="w-full bg-black border border-gray-600 px-3 py-2 mb-4 rounded text-white"></textarea>

        <label class="block mb-1">Photo</label>
        <input type="file" id="itemPhoto" class="w-full text-white mb-4"/>

        <!-- In Stock Checkbox -->
        <label class="inline-flex items-center mb-4">
          <input type="checkbox" id="itemInStock" class="mr-2 rounded bg-black border-gray-600">
          <span>In Stock</span>
        </label>

        <div class="flex justify-end gap-3">
          <button type="button" onclick="closeModal()" class="px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-500">Cancel</button>
          <button type="submit" class="px-4 py-2 bg-yellow-400 text-black rounded font-semibold hover:bg-yellow-300">Save</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    const kitchenId = document.getElementById('kitchenId').value;
    const menuList = document.getElementById('menuList');
    const modal = document.getElementById('modal');
    const form = document.getElementById('menuForm');
    const loading = document.getElementById('loading');
    const searchInput = document.getElementById('searchInput');
    let menuData = [];

    function openModal(editItem = null) {
      modal.classList.remove('hidden');
      document.getElementById("modalTitle").textContent = editItem ? "Edit Menu Item" : "Add New Menu Item";

      if (editItem) {
        document.getElementById("editingItemId").value = editItem._id;
        document.getElementById("itemName").value = editItem.name;
        document.getElementById("itemPrice").value = editItem.price;
        document.getElementById("itemDescription").value = editItem.description;
        document.getElementById("itemInStock").checked = editItem.inStock;
      } else {
        form.reset();
        document.getElementById("editingItemId").value = "";
      }
    }

    function closeModal() {
      modal.classList.add('hidden');
      form.reset();

      setTimeout(() => {
        loadMenu(); // ‚úÖ Reloads menu after modal closes
      }, 300);
    }

    async function loadMenu() {
      loading.classList.remove("hidden");
      try {
        const res = await fetch(`http://localhost:5000/api/menu/${kitchenId}`);
        const items = await res.json();
        menuData = items;
        renderMenu(items);
      } catch (err) {
        console.error("Failed to fetch menu:", err);
      } finally {
        loading.classList.add("hidden");
      }
    }

    function renderMenu(items) {
      menuList.innerHTML = "";
      items.forEach(item => {
        const card = document.createElement("div");
        card.className = "bg-gray-900 border border-yellow-400 p-4 rounded-xl shadow hover:shadow-yellow-500/40 transition duration-300";

        const imageHTML = item.photo ? `<img src="http://localhost:5000/uploads/${item.photo}" class="w-full h-40 object-cover rounded mb-3 border border-yellow-300" />` : '';

        card.innerHTML = `
          ${imageHTML}
          <h3 class="font-bold text-xl text-yellow-300">${item.name}</h3>
          <p class="text-gray-300 text-sm mt-1">${item.description || "No description."}</p>
          <p class="mt-2 text-yellow-400 font-bold">‚Çπ${item.price}</p>
          <span class="inline-block mt-2 px-2 py-1 text-xs font-semibold rounded-full ${item.inStock ? 'bg-green-600' : 'bg-red-600'} text-white">
            ${item.inStock ? 'In Stock' : 'Out of Stock'}
          </span>
          <div class="mt-4 flex gap-2">
            <button onclick='toggleStock("${item._id}")' class="text-sm bg-yellow-300 text-black px-2 py-1 rounded hover:bg-yellow-200">${item.inStock ? 'Set Out of Stock' : 'Set In Stock'}</button>
            <button onclick='openModal(${JSON.stringify(item)})' class="text-sm bg-blue-600 px-2 py-1 rounded hover:bg-blue-500 text-white">Edit</button>
            <button onclick='deleteItem("${item._id}")' class="text-sm bg-red-600 px-2 py-1 rounded hover:bg-red-500 text-white">Delete</button>
          </div>
        `;

        menuList.appendChild(card);
      });
    }

    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      const itemId = document.getElementById("editingItemId").value;
      const name = document.getElementById("itemName").value;
      const price = document.getElementById("itemPrice").value;
      const description = document.getElementById("itemDescription").value;
      const photoFile = document.getElementById("itemPhoto").files[0];
      const inStock = document.getElementById("itemInStock").checked;

      const formData = new FormData();
      formData.append("kitchenId", kitchenId);
      formData.append("name", name);
      formData.append("price", price);
      formData.append("description", description);
      formData.append("inStock", inStock);
      if (photoFile) formData.append("photo", photoFile);

      let url = "http://localhost:5000/api/menu";
      let method = "POST";

      if (itemId) {
        url += `/${itemId}`;
        method = "PUT";
      }

      const res = await fetch(url, {
        method,
        body: formData,
      });

      if (res.ok) {
        closeModal(); // ‚úÖ loadMenu is triggered inside this now
      } else {
        alert("Failed to save item.");
      }
    });

    async function deleteItem(id) {
      if (confirm("Are you sure you want to delete this item?")) {
        await fetch(`http://localhost:5000/api/menu/${id}`, { method: "DELETE" });
        loadMenu();
      }
    }

    async function toggleStock(id) {
      await fetch(`http://localhost:5000/api/menu/toggle-stock/${id}`, { method: "PATCH" });
      loadMenu();
    }

    searchInput.addEventListener("input", () => {
      const keyword = searchInput.value.toLowerCase();
      const filtered = menuData.filter(item =>
        item.name.toLowerCase().includes(keyword) ||
        (item.description && item.description.toLowerCase().includes(keyword))
      );
      renderMenu(filtered);
    });

    window.onload = loadMenu;
  </script>
</body>
</html>
